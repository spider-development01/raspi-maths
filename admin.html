    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>π SCHOOL Admin Panel - Analytics</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
        <style>
            :root { --bg-grad: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); --glass: rgba(255, 255, 255, 0.1); --accent: #00d2ff; --secondary: #9b59b6; }
            * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
            body { margin: 0; background: var(--bg-grad); color: white; min-height: 100vh; overflow-x: hidden; }
            
            /* Login UI */
            #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(20px); display: flex; justify-content: center; align-items: center; z-index: 1000; }
            .login-card { background: rgba(16, 25, 40, 0.95); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
            .input-group { margin-bottom: 20px; text-align: left; position: relative; }
            .input-group label { display: block; margin-bottom: 8px; font-size: 0.8rem; color: #aaa; }
            .input-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: rgba(255,255,255,0.05); color: white; outline: none; }
            .eye-icon { position: absolute; right: 12px; bottom: 10px; cursor: pointer; width: 20px; fill: #aaa; }
            .btn-login { width: 100%; padding: 14px; border-radius: 8px; border: none; background: var(--accent); font-weight: bold; cursor: pointer; }
            
            /* Dashboard UI */
            #dashboard { display: none; padding: 20px; max-width: 1400px; margin: 0 auto; }
            .header { display: flex; justify-content: space-between; align-items: center; background: var(--glass); padding: 15px 25px; border-radius: 15px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
            .esp-admin-input { background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; padding: 8px; border-radius: 5px; width: 140px; margin-right: 10px; text-align: center; }

            .tab-nav { display: flex; gap: 10px; margin-bottom: 20px; }
            .tab-btn { background: rgba(255,255,255,0.05); color: #aaa; border: 1px solid rgba(255,255,255,0.1); padding: 10px 25px; border-radius: 50px; cursor: pointer; }
            .tab-btn.active { background: var(--accent); color: #000; font-weight: bold; }
            
            .tab-content { display: none; }
            .tab-content.active { display: block; animation: fadeIn 0.4s; }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

            .grid-container { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 20px; }
            .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
            .card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; }
            .stat-val { font-size: 2.5rem; font-weight: bold; color: var(--accent); }

            table { width: 100%; border-collapse: collapse; }
            th { text-align: left; color: var(--accent); padding: 12px; border-bottom: 1px solid #444; }
            td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
            
            .reset-btn { background: rgba(255,255,255,0.1); color: white; padding: 8px 15px; border: 1px solid #555; cursor: pointer; border-radius: 5px; margin-right: 10px; }
            .logout-btn { background: #ff4757; color: white; padding: 8px 15px; border: none; cursor: pointer; border-radius: 5px; }

            /* Modal */
            .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; z-index: 2000; }
            .modal-content { background: #1e272e; width: 90%; max-width: 800px; padding: 30px; border-radius: 20px; position: relative; }
            .close-btn { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; }
        </style>
    </head>
    <body>

        <!-- Login -->
        <div id="login-screen">
            <div class="login-card">
                <h2 style="color:var(--accent); letter-spacing:2px;">π SCHOOL ADMIN</h2>
                <div class="input-group">
                    <label>Username</label>
                    <input type="text" id="user" value="teacher">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="pass" value="teacher">
                    <svg class="eye-icon" onclick="togglePass()" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                </div>
                <button class="btn-login" onclick="login()">SECURE LOGIN</button>
                <p id="error-msg" style="color:#ff6b6b; display:none; margin-top:10px;">Invalid Credentials</p>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard">
            <div class="header">
                <h2 style="margin:0;">π SCHOOL ANALYTICS</h2>
                <div>
                    <input type="text" id="adminEspIp" class="esp-admin-input" placeholder="ESP IP" oninput="saveAdminIP()">
                    <button class="reset-btn" onclick="resetDB()">Reset DB</button>
                    <button class="logout-btn" onclick="logout()">LOGOUT</button>
                </div>
            </div>

            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab(this, 'overview')">Live Overview</button>
                <button class="tab-btn" onclick="switchTab(this, 'analytics')">Advanced Analytics</button>
            </div>

            <div id="overview" class="tab-content active">
                <div class="grid-container">
                    <div class="card"><h4>Daily Count</h4><canvas id="dailyChart"></canvas></div>
                    <div class="card"><h4>Weekly Trend</h4><canvas id="weeklyChart"></canvas></div>
                </div>
                <div class="card">
                    <table>
                        <thead><tr><th>Adm No</th><th>Name</th><th>Time</th><th>Status</th></tr></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="analytics" class="tab-content">
                <div class="stats-grid">
                    <div class="card"><div class="stat-val" id="val-mean">--</div><div>Mean</div></div>
                    <div class="card"><div class="stat-val" id="val-median">--</div><div>Median</div></div>
                    <div class="card"><div class="stat-val" id="val-mode">--</div><div>Mode</div></div>
                    <div class="card"><div class="stat-val" id="val-consistency">--%</div><div>Consistency</div></div>
                </div>
                <div class="card"><div style="height:300px;"><canvas id="lineChart"></canvas></div></div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal" id="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="closeModal()">&times;</span>
                <h2 id="mName">--</h2>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <canvas id="studentBar"></canvas>
                    <div>
                        <canvas id="studentPie"></canvas>
                        <div style="text-align:center; margin-top:20px; padding:15px; background:rgba(0,0,0,0.2); border-radius:10px;">
                            <small>PROBABILITY</small><br><strong id="mProb" style="font-size:1.5rem;">--%</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Use var and rename to dbClient to avoid "already declared" errors
            var dbClient; 
            const SUPABASE_URL = 'https://sbizlblusoergeluicdj.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNiaXpsYmx1c29lcmdlbHVpY2RqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxOTI3MDAsImV4cCI6MjA4MDc2ODcwMH0.m9wIHdTRONaC-ckJF_dPs_F-eULaD3riWgu2_e21mlc';

            // Variables for Charts
            var dailyChart, weeklyChart, lineChart, barInstance, pieInstance;
            var allAttendanceData = [];
            const TOTAL_STUDENTS = 8;

            // Initialize Supabase properly
            try {
                dbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } catch(e) {
                console.error("Supabase Init Error", e);
            }

            // Global Functions (Must be defined before they are called)
            window.togglePass = function() {
                const x = document.getElementById('pass');
                x.type = x.type === "password" ? "text" : "password";
            };

            window.login = function() {
                const u = document.getElementById('user').value;
                const p = document.getElementById('pass').value;
                if(u === "teacher" && p === "teacher") {
                    localStorage.setItem("adminLoggedIn", "true");
                    showDashboard();
                } else {
                    document.getElementById('error-msg').style.display = 'block';
                }
            };

            window.logout = function() {
                localStorage.removeItem("adminLoggedIn");
                location.reload();
            };

            window.switchTab = function(btn, tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                btn.classList.add('active');
            };

            function showDashboard() {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                fetchData();
                setInterval(fetchData, 5000);
            }

            async function fetchData() {
                const { data, error } = await dbClient.from('attendance').select('*').order('created_at', { ascending: false });
                if(error) return;
                allAttendanceData = data;
                updateUI();
            }

            function getLocalYMD(d) { return d.toLocaleDateString('en-CA'); }

            function updateUI() {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = allAttendanceData.map(row => `
                    <tr onclick="openModal('${row.name}')">
                        <td>${row.admission_no}</td>
                        <td>${row.name}</td>
                        <td>${new Date(row.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
                        <td style="color:#2ecc71">${row.status}</td>
                    </tr>`).join('');

                const todayStr = getLocalYMD(new Date());
                const todayCount = allAttendanceData.filter(d => getLocalYMD(new Date(d.created_at)) === todayStr).length;

                // Weekly Logic
                const weekCounts = [0,0,0,0,0,0];
                const monday = new Date();
                monday.setDate(monday.getDate() - (monday.getDay() || 7) + 1);

                for(let i=0; i<6; i++) {
                    let d = new Date(monday);
                    d.setDate(monday.getDate() + i);
                    weekCounts[i] = allAttendanceData.filter(x => getLocalYMD(new Date(x.created_at)) === getLocalYMD(d)).length;
                }

                renderCharts(todayCount, weekCounts);
                updateAnalytics(weekCounts);
            }

            function renderCharts(today, week) {
                if(dailyChart) dailyChart.destroy();
                dailyChart = new Chart(document.getElementById('dailyChart'), {
                    type: 'doughnut',
                    data: { labels: ['Present', 'Absent'], datasets: [{ data: [today, TOTAL_STUDENTS - today], backgroundColor: ['#00d2ff', '#333'], borderWidth: 0 }] },
                    options: { plugins: { legend: { labels: { color: 'white' } } } }
                });

                if(weeklyChart) weeklyChart.destroy();
                weeklyChart = new Chart(document.getElementById('weeklyChart'), {
                    type: 'bar',
                    data: { labels: ['M', 'T', 'W', 'T', 'F', 'S'], datasets: [{ data: week, backgroundColor: '#3a7bd5' }] },
                    options: { scales: { y: { beginAtZero: true, max: TOTAL_STUDENTS, ticks:{color:'white'} } }, plugins: { legend: { display: false } } }
                });
            }

            function updateAnalytics(arr) {
                const mean = (arr.reduce((a,b)=>a+b,0)/6).toFixed(1);
                document.getElementById('val-mean').innerText = mean;
                document.getElementById('val-consistency').innerText = ((mean/TOTAL_STUDENTS)*100).toFixed(1) + "%";

                if(lineChart) lineChart.destroy();
                lineChart = new Chart(document.getElementById('lineChart'), {
                    type: 'line',
                    data: { labels: ['M','T','W','T','F','S'], datasets: [{ data: arr, borderColor: '#9b59b6', fill: true, backgroundColor: 'rgba(155,89,182,0.1)' }] },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }

            window.openModal = function(name) {
                document.getElementById('modal').style.display = 'flex';
                document.getElementById('mName').innerText = name;
                const records = allAttendanceData.filter(d => d.name === name);
                const presentCount = [...new Set(records.map(r => getLocalYMD(new Date(r.created_at))))].length;
                document.getElementById('mProb').innerText = Math.round((presentCount/6)*100) + "%";
            };

            window.closeModal = function() { document.getElementById('modal').style.display = 'none'; };

            window.onload = () => {
                if(localStorage.getItem("adminLoggedIn") === "true") showDashboard();
            };

            window.saveAdminIP = () => localStorage.setItem('esp_ip_admin', document.getElementById('adminEspIp').value);
            
            window.resetDB = async () => {
                if(!confirm("Reset all data?")) return;
                await dbClient.from('attendance').delete().neq('id', 0);
                fetchData();
            };
        </script>
    </body>
    </html>
