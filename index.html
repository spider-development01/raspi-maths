<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>π SCHOOL Attendance - Student</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --glass-bg: rgba(255, 255, 255, 0.1); --accent: #00d2ff; }
        body {
            margin: 0; font-family: 'Poppins', sans-serif;
            background: linear-gradient(45deg, #0f2027, #203a43, #2c5364);
            color: white; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .container {
            background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
            padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 500px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        .school-title {
            font-size: 2.5rem; font-weight: 700; margin-bottom: 20px; letter-spacing: 3px;
            cursor: pointer; user-select: none; transition: 0.3s; text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .video-box {
            width: 100%; height: 300px; background: black; border-radius: 10px; overflow: hidden;
            position: relative; border: 2px solid rgba(255,255,255,0.1);
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--accent);
            box-shadow: 0 0 15px var(--accent); animation: scan 2s infinite;
        }
        @keyframes scan { 0% {top:0} 50% {top:100%} 100% {top:0} }
        
        button {
            margin-top: 20px; padding: 15px 40px; border-radius: 50px; border: none;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5); color: white; font-weight: bold;
            font-size: 1.1rem; cursor: pointer; transition: 0.3s;
        }
        button:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0,210,255,0.5); }
        
        .alert { background: #e74c3c; color: white; padding: 10px; border-radius: 5px; margin-top: 15px; display: none; font-weight: bold; }

        .ip-config { margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; align-items: center; }
        .ip-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #00d2ff; padding: 8px; border-radius: 5px; width: 200px; text-align: center; font-size: 0.8rem; }

        /* Popup Styles */
        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .popup-content {
            background: #1e272e; padding: 30px; border-radius: 20px;
            border: 2px solid var(--accent); text-align: center; width: 90%; max-width: 400px;
            animation: popIn 0.3s ease;
        }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .checkmark-circle { width: 60px; height: 60px; background: var(--accent); border-radius: 50%; margin: 0 auto 15px auto; display: flex; justify-content: center; align-items: center; }
        .checkmark { display: inline-block; width: 20px; height: 10px; border-bottom: 4px solid #fff; border-left: 4px solid #fff; transform: rotate(-45deg); margin-top: -5px; }
        .popup-btn { margin-top: 20px; background: var(--accent); color: #000; padding: 10px 30px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="school-title" id="schoolHeader" onclick="toggleLock()"> π SCHOOL ATTENDANCE</h1>
        
        <div class="video-box">
            <!-- Added muted and playsinline to fix black screen -->
            <video id="cam" autoplay muted playsinline></video>
            <div class="scan-line"></div>
        </div>
        <button onclick="mark()">Mark Attendance</button>
        <div class="alert" id="alert">NOT AUTHORIZED</div>

        <div class="ip-config">
            <label style="font-size:0.8rem; color:#888; margin-bottom:5px;">ESP8266 IP Address:</label>
            <input type="text" id="espIpInput" class="ip-input" placeholder="enter" oninput="saveIP()">
        </div>
    </div>

    <div class="popup-overlay" id="successPopup">
        <div class="popup-content">
            <div class="checkmark-circle"><div class="checkmark"></div></div>
            <h2 style="margin-bottom: 10px;">Success!</h2>
            <p id="popupMessage" style="font-size: 1.1rem; line-height: 1.5; color: #ddd;"></p>
            <button class="popup-btn" onclick="closePopup()">OK</button>
        </div>
    </div>

    <script>
        // Use 'var' or different name to avoid re-declaration errors
        var dbClient;
        const SUPABASE_URL = 'https://sbizlblusoergeluicdj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNiaXpsYmx1c29lcmdlbHVpY2RqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxOTI3MDAsImV4cCI6MjA4MDc2ODcwMH0.m9wIHdTRONaC-ckJF_dPs_F-eULaD3riWgu2_e21mlc';
        
        // Init Supabase
        dbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Load Camera with Error Handling
        const video = document.getElementById('cam');
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
                .then(stream => {
                    video.srcObject = stream;
                })
                .catch(err => {
                    console.error("Camera Error:", err);
                    alert("Camera Access Denied. Please enable camera in browser settings.");
                });
        }

        // ESP IP Logic
        let currentEspIP = localStorage.getItem('esp_ip_student') || '';
        document.getElementById('espIpInput').value = currentEspIP;

        function saveIP() {
            currentEspIP = document.getElementById('espIpInput').value;
            localStorage.setItem('esp_ip_student', currentEspIP);
        }

        let clicks = 0;
        let isSystemLocked = false; 

        const users = [
            { n: "Divyansh Sachdeva", c: "IX - α", a: "1609", url: "/led1" },
            { n: "Aryann Narang", c: "IX - α", a: "4003", url: "/led2" }
        ];

        window.toggleLock = function() {
            isSystemLocked = !isSystemLocked;
            console.log("System Locked:", isSystemLocked);
        };

        window.mark = async function() {
            const alertBox = document.getElementById('alert');
            alertBox.style.display = 'none';

            if(isSystemLocked) {
                alertBox.innerText = "NOT AUTHORIZED (SYSTEM LOCKED)";
                alertBox.style.display = 'block';
                return;
            }

            if(clicks < users.length) {
                const u = users[clicks];
                
                // Show Popup Immediately
                const msg = `Attendance marked for<br><strong style="color:#00d2ff">${u.n}</strong><br>Adm No: ${u.a}`;
                document.getElementById('popupMessage').innerHTML = msg;
                document.getElementById('successPopup').style.display = 'flex';
                
                // 2. Trigger ESP (Mode no-cors is essential)
                const ip = currentEspIP.startsWith('http') ? currentEspIP : 'http://' + currentEspIP;
                fetch(ip + u.url, { mode: 'no-cors' }).catch(e => console.log("ESP Offline"));

                // 3. Database
                const startOfDay = new Date();
                startOfDay.setHours(0,0,0,0);
                
                try {
                    // Delete old record for today (avoid duplicates)
                    await dbClient.from('attendance')
                        .delete()
                        .eq('admission_no', u.a)
                        .gte('created_at', startOfDay.toISOString());

                    // Insert new record
                    await dbClient.from('attendance')
                        .insert([{ name: u.n, admission_no: u.a, class: u.c, status: 'Present' }]);
                } catch(e) {
                    console.error("DB Error:", e);
                }

                clicks++;
                setTimeout(closePopup, 3000);
            } else {
                alertBox.innerText = "NOT AUTHORIZED (Unknown User)";
                alertBox.style.display = 'block';
            }
        };

        window.closePopup = function() {
            document.getElementById('successPopup').style.display = 'none';
        };
    </script>
</body>
</html>
